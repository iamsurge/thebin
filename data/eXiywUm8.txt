using System;
using System.Threading;

namespace ConsoleApp19
{
    class Program
    {
        public static int[] A;
        public static int ArrayLen;
        public static int ThreadCount;
        public static object Locker = new object();
        public static int SubArrayLen;
        public static int Result = 0;

        static void Main(string[] args)
        {
            string inputData;
            Console.Write("Длина массива: ");
            inputData = Console.ReadLine();

            if (int.TryParse(inputData,out ArrayLen) == false || ArrayLen < 1)
            {
                ArrayLen = 10;
                Console.WriteLine($"Сброс до стандартных значений: {ArrayLen}");
            }
            A = new int[ArrayLen];
            Console.WriteLine("Заполнение массива:");
            UserInputArray(ref A);
            Console.WriteLine("Элементы массива: ");
            foreach (int item in A)
                Console.Write($"{item} ");
            Console.Write("\nКоличество потоков: ");
            inputData = Console.ReadLine();

            if (int.TryParse(inputData,out ThreadCount) == false|| ThreadCount < 1)
            {
                ThreadCount = 1;
                Console.WriteLine($"Сброс до стандартных значений: {ThreadCount}");
            }

            if (ThreadCount > ArrayLen)
                ArrayLen = ThreadCount;
            SubArrayLen = ArrayLen / ThreadCount + 1;
            Thread[] threads = new Thread[ThreadCount];

            for (int i = 0; i < ThreadCount; i++)
            {
                PartArray partArray = new PartArray
                {
                    StartIndex = i * SubArrayLen,
                    EndIndex = (i + 1) * SubArrayLen
                };

                if (partArray.EndIndex > ArrayLen)
                    partArray.EndIndex = ArrayLen;
                threads[i] = new Thread(() => SumWith3(partArray));
                threads[i].Name = $"Поток№{i+1}";
                threads[i].Start();
            }

            foreach (Thread item in threads)
            {
                Console.WriteLine($"{item.Name} - запустился");
                item.Join();
                Console.WriteLine($"{item.Name} - закончил");
            }
            Console.WriteLine($"Результат: {Result}");
            Console.ReadLine();
        }

        private static void UserInputArray(ref int[] array)
        {
            for (int i = 0; i < array.Length; i++)
            {
                Console.Write($"{i+1}:");

                if (int.TryParse(Console.ReadLine(), out array[i]) == false || array[i] < 1)
                {
                    Console.WriteLine("Неправильный ввод");
                    i--;
                }
            }
        }

        private static void SumWith3(PartArray partArray)
        {
            int start = partArray.StartIndex;
            int end = partArray.EndIndex;

            for (int i = start; i < end; i++)
            {
                if (A[i].ToString().EndsWith('3'))
                    lock (Locker)
                        Result += A[i];
            }
        }
    }

    class PartArray
    {
        public int StartIndex;
        public int EndIndex;
    }
}