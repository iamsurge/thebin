using System;
using System.Threading;

namespace ConsoleApp23
{
    class Program
    {
        public static int[] A; //Массив чисел
        public static int CountElements; //Количество элементов
        public static int CountThreads; //Количество потоков
        public static int SubArrayLen; //Длина части массива
        public static int MaxOddNumber = 0; //результат
        public static object Locker = new object();

        static void Main(string[] args)
        {
            string userInput; // переменная хранит пользовательский ввод
            Console.Write("Количество элементов в массиве: ");
            userInput = Console.ReadLine();

            if (int.TryParse(userInput,out CountElements) == false || CountElements < 1)//Проверка на ввод пользователя
            {
                CountElements = 10;
                Console.Write($"Количество элменетов заданы не правильно: {CountElements}");
            }
            A = new int[CountElements];
            Console.WriteLine("\nКоличество потоков: ");
            userInput = Console.ReadLine();

            if (int.TryParse(userInput,out CountThreads) == false || CountThreads < 1)//Проверка на ввод пользователя
            {
                CountThreads = 1;
                Console.WriteLine($"Количество потоков заданы не правильно: {CountThreads}");
            }

            if (CountThreads > CountElements) //Проверка, чтобы количество потоков не было больше количества элементов
                CountThreads = CountElements;
            Console.WriteLine("Заполнение массива A:");

            for (int i = 0; i < CountElements; i++)
            {
                Console.Write((i+1) + ": ");

                if (int.TryParse(Console.ReadLine(),out A[i]) == false || A[i] < 1)//Проверка на ввод пользователя
                {
                    Console.WriteLine("Нерпавильный ввод: ");
                    i--;
                }
            }
            Console.Clear();
            Console.Write("Элементы массива: ");

            foreach (int item in A) //Вывод всех элементов массива в консоль
                Console.Write($"{item} ");
            Console.WriteLine();
            SubArrayLen = CountElements / CountThreads + 1; //Длина части массива
            Thread[] threads = new Thread[CountThreads]; //Массив потоков

            for (int i = 0; i < CountThreads; i++) //Цикл, который пробегает по потокам, дает им часть массива, имя и запускает их
            {
                PartArray partArray = new PartArray
                {
                    StartIndex = i * SubArrayLen,
                    EndIndex = (i + 1) * SubArrayLen
                };

                if (partArray.EndIndex > CountElements) //Проверка на выход за границы массива
                    partArray.EndIndex = CountElements;
                threads[i] = new Thread(() => FindMaxOddNumber(partArray));
                threads[i].Name = "Поток№" + (i+1);
                threads[i].Start();
            }

            foreach (Thread thread in threads) //Цикл ожидания заверщения потоков
            {
                Console.WriteLine($"{thread.Name} - начал");
                thread.Join();
                Console.WriteLine($"{thread.Name} - закончил");
            }
            Console.WriteLine($"Максимальное нечетное число: {MaxOddNumber}"); //Вывод результата
            Console.ReadLine();
        }
        /*
         Метод с циклом, который пробегает свою часть массива
            проверяет числа на четность
            проверяет больше ли это число чем уже нашли
            и записывает ее в общую переменную
         */
        private static void FindMaxOddNumber(PartArray partArray)
        {
            int start = partArray.StartIndex;
            int end = partArray.EndIndex;

            for (int i = start; i < end; i++)
                if (A[i] % 2 != 0)
                    if (MaxOddNumber < A[i])
                        lock (Locker) //блокирует переменную, и застовляет другие потоки джать, пока она освободится. 
                            MaxOddNumber = A[i];
        }
    }

    class PartArray //Класс хранит 2 переменные, начальный и конечный индекс части массива
    {
        public int StartIndex;
        public int EndIndex;
    }
}