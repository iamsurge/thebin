#!/bin/bash

FROMID=$( echo "$envmessage" | jq -c '.from.id' )
if [[ "$FROMID" = "" ]]; then
 echo "EMPTY ID"
 exit 1
fi

funcanswer0(){
TOKEN=''
CHAT_ID="$1"
# TEXT=""
curl -s -X POST \
https://api.telegram.org/bot"$TOKEN"/sendMessage \
-d chat_id="$CHAT_ID" \
-d text="$TEXT""$MPCTEXT" -o /dev/null
}

mpcradiofunc(){
INTEXTVAR=$( echo "$envmessage" | jq '.text' )
 RADIOTEST=$( echo "$INTEXTVAR" | tr '[:upper:]' '[:lower:]' |\
  grep -oP '(play|stop|vol)' )
 RDIGIT=$( echo "$INTEXTVAR" |\
  grep -oP '(play|stop|vol)..[[:digit:]]*' |\
    grep -oP '(\+|\-|\ )[[:digit:]]*' )
if [[ "$RADIOTEST" = 'play' ]];  then
 MPCTEXT="$( mpc play $RDIGIT )"
 funcanswer0 "$FROMID"
elif [[ "$RADIOTEST" = 'stop' ]];  then
 MPCTEXT="$( mpc stop )"
 funcanswer0 "$FROMID"
elif [[ "$RADIOTEST" = 'vol' ]];  then
 MPCTEXT="$( mpc vol $RDIGIT )"
 funcanswer0 "$FROMID"
  fi
}

AID=$( cat authorized.txt | grep -in "$FROMID" | sed 's/:/ /g' )
SNUM=$( echo "$AID" | cut -d ' ' -f 1 )
NAME=$( echo "$AID" | cut -d ' ' -f 3 )

if [[ "$AID" != "" ]]; then
 echo "$NAME"
 mpcradiofunc
else
 echo ERROR ID "$FROMID"
 echo UNAUTHORIZED
 TEXT="UNAUTHORIZED ID $FROMID"
 funcanswer0 270281282
fi
