local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService('ReplicatedStorage')
local RunService = game:GetService("RunService")

ReplicatedStorage.DiscotackleEvent.OnServerEvent:Connect(function(caster)
	local Character = caster.Character
	local Humanoid = Character.Humanoid; Humanoid:ChangeState(Enum.HumanoidStateType.None)
	local HRP = Character.HumanoidRootPart
	HRP.Anchored = true
	
	task.wait(.1)
	
	local centerBall = Instance.new("Part")
	centerBall.Size = Vector3.new(0.1,0.1,0.1)
	centerBall.CFrame = HRP.CFrame * CFrame.new(0,0,-4)
	centerBall.CanCollide = false
	centerBall.Anchored = true
	centerBall.Material = Enum.Material.Neon
	centerBall.Color = Color3.new(0,0,0)
	centerBall.Shape = "Ball"
	centerBall.CastShadow = false
	centerBall.Parent = workspace.Junk
	
	local function PlaySound(Sound : Sound, Loop : boolean, Parent)
		Sound = Sound:Clone()
		Sound.Parent = Parent or centerBall

		if Loop then
			Sound.Looped = true
		end

		Sound:Play()
		
		task.spawn(function()
			if not Loop then
				task.wait(Sound.TimeLength)
				Sound:Destroy()
			end
		end)
		
		return Sound
	end
	
	local Goals = { --GOALS
		CenterBallEnter = {
			Size = Vector3.new(2, 2, 2),
			CFrame = centerBall.CFrame * CFrame.new(0,5,0),
			Color = Color3.new(1,1,1)
		},
		
		CenterBallRetract = {
			Size = Vector3.new(.1, .1, .1),
			Color = Color3.new(0,0,0)
		},
		
		CenterBallReform = {
			Size = Vector3.new(4, 4, 4)
		},
	}
	
	local Infos = { --TWEEN INFORMATION
		CenterBallEnter = TweenInfo.new(2.5, Enum.EasingStyle.Quint),
		Retract = TweenInfo.new(.5, Enum.EasingStyle.Quint)
	}
	
	local CenterBallEnterTween = TweenService:Create(centerBall, Infos.CenterBallEnter, Goals.CenterBallEnter)
	CenterBallEnterTween:Play()
	PlaySound(script.DiscoEnter, false)
	
	
	local Colors = {
		xColor1 = Color3.fromHSV(.1, .8, 1),
		xColor2 = Color3.fromHSV(.2, .8, 1),
		xColor3 = Color3.fromHSV(.3, .8, 1),
		xColor4 = Color3.fromHSV(.4, .8, 1),
		xColor5 = Color3.fromHSV(.5, .8, 1),
		xColor6 = Color3.fromHSV(.6, .8, 1),
		xColor7 = Color3.fromHSV(.7, .8, 1),
		xColor8 = Color3.fromHSV(.8, .8, 1),
		xColor9 = Color3.fromHSV(.9, .8, 1)
		
	}
	local GlobalColor = nil
	
	task.spawn(function() --SHUFFLE COLORS
		while true do
			for i, v in pairs(Colors) do
				GlobalColor = v
				task.wait(.15)
			end
		end
	end)
	
	-----------------------------------------------------------------------------------------------
	
	local function ConnectColorShuffling(Part) --STARTS COLOR SHIFTING FOR THE PART 
		task.spawn(function()
			while true do
				if Part:IsA("BasePart") then
					local Tween = TweenService:Create(Part, TweenInfo.new(.15), {Color = GlobalColor})
					Tween:Play(); Tween.Completed:Wait()
				elseif Part == game.Lighting.ColorCorrection then
					local h,s,v = GlobalColor:ToHSV()
					local c = Color3.fromHSV(h, .085, v)
					local Tween = TweenService:Create(Part, TweenInfo.new(.15), {TintColor = c})
					Tween:Play(); Tween.Completed:Wait()
				else
					local Beam = Part
					Beam.Color = ColorSequence.new(GlobalColor)
					task.wait(.1)
				end
			end
		end)
	end
	
		
	-----------------------------------------------------------------------------------------------
	
	CenterBallEnterTween.Completed:Wait() --Finished
	
	--RETRACT
	local CenterBallRetract = TweenService:Create(centerBall, Infos.Retract, Goals.CenterBallRetract)
	PlaySound(script.Swish, false)
	CenterBallRetract:Play(); CenterBallRetract.Completed:Wait()
	
	task.wait(.85)
	
	PlaySound(script.Charge, false)
	
	task.spawn(function()
		local ripple = centerBall:Clone()
		ripple.Parent = workspace
		TweenService:Create(ripple, TweenInfo.new(1), {Size = Vector3.new(2,2,2), Transparency = 1}):Play()
		task.wait(1)
		ripple:Destroy()
	end)
	
	task.wait(1)
	
	--START THE RAVE
	Humanoid.Animator:LoadAnimation(script.Animation):Play()
	
	local CenterBallReform = TweenService:Create(centerBall, Infos.CenterBallEnter, Goals.CenterBallReform)
	CenterBallReform:Play()
	local HardstyleMusic = PlaySound(script.Hardstyle, false)
	TweenService:Create(HardstyleMusic, TweenInfo.new(1), {Volume = 1.5}):Play()
	ConnectColorShuffling(centerBall)
	ReplicatedStorage.DiscotackleEvent:FireAllClients(HardstyleMusic, centerBall)
	
	--GIVE THE SHINE EFFECTS
	local a = Instance.new("Attachment", centerBall)
	for _, v in pairs(script.CenterBallEffects:GetChildren()) do
		local effect = v:Clone()
		effect.Parent = a
	end
	
	--LASER BEAM
	
	local MainBeam = Instance.new("Part")
	MainBeam.Material = Enum.Material.Neon
	MainBeam.CanCollide = false
	MainBeam.Anchored = true
	MainBeam.CastShadow = false
	MainBeam.Shape = "Cylinder"
	MainBeam.Parent = workspace.Junk
	
	local EndSpot = Instance.new("Part")
	EndSpot.Size = Vector3.new(1,1,1)
	EndSpot.CanCollide = false
	EndSpot.Anchored = true
	EndSpot.Material = Enum.Material.Neon
	EndSpot.Color = Color3.new(0,0,0)
	EndSpot.Shape = "Ball"
	EndSpot.Parent = workspace.Junk
	
	ConnectColorShuffling(MainBeam)
	ConnectColorShuffling(EndSpot)
	ConnectColorShuffling(game.Lighting.ColorCorrection)
	
	PlaySound(script.Laser, true, MainBeam)
	
	local startAttachment = a
	local endAttachment = Instance.new("Attachment", EndSpot)
	
	local effects_ = script.BeamEffects:GetChildren()
	local effects_2 = script.EndPointEffects:GetChildren()
	
	for i, v in pairs(effects_) do
		local effect = v:Clone()
		effect.Parent = MainBeam
		if effect:IsA("Beam") then
			effect.Attachment0 = startAttachment
			effect.Attachment1 = endAttachment
			
			ConnectColorShuffling(effect)
		end
	end
	
	local a2 = Instance.new("Attachment", EndSpot)
	for i, v in pairs(effects_2) do
		local effect = v:Clone()
		effect.Parent = a2
	end
	
	RunService.Heartbeat:Connect(function(dt)
		ReplicatedStorage.Shake:FireAllClients()
		
		local MousePosition, Normal = ReplicatedStorage.GetMouseInfo:InvokeClient(caster)
		
		if MousePosition then
			local Origin = centerBall.Position
			local Direction = (MousePosition - Origin).Unit * (MousePosition - Origin).Magnitude
			local Middle = Origin + Direction/2
			
			local _x, _y, _z = CFrame.lookAt(HRP.Position, MousePosition):ToOrientation()
			HRP.Orientation = Vector3.new(0, math.deg(_y), 0)
			
			MainBeam.CFrame = MainBeam.CFrame:Lerp(CFrame.lookAt(Middle, Origin) * CFrame.Angles(0,math.rad(90),0), .95)
			MainBeam.Size = Vector3.new(Direction.Magnitude, .5, .5)
			
			EndSpot.CFrame = CFrame.new(MousePosition)
			
			--BURN CREATION
			
			local newBurn = script.Burn:Clone()
			newBurn.Parent = workspace.Junk
			newBurn.CFrame = CFrame.lookAt(MousePosition, MousePosition + Normal) * CFrame.Angles(0, math.rad(90), 0)
			
			task.delay(.5, function()
				local Tween = TweenService:Create(newBurn, TweenInfo.new(1), {Transparency = 1, Size = Vector3.new(0,0,0)})
				Tween:Play(); Tween.Completed:Wait()
				game.Debris:AddItem(newBurn, 0)
			end)
		end
		
	end)

end)