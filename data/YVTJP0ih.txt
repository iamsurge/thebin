APIKEY = ...
API = ...


def solve_captcha(url, key, proxy="", ua=""):
    data = {
        "clientKey": APIKEY,
        "task": {
            "type": "HCaptchaTaskProxyless" if not proxy else "HCaptchaTask",
            "websiteURL": url,
            "websiteKey": key,
            "userAgent": ua,
            "isInvisible": False,
        },
        "softId": 0,
    }

    r = requests.post(API + "createTask", json=data)
    r_json = r.json()
    check_error(r_json)
    task_id: int = r_json["taskId"]
    data = {
        "clientKey": APIKEY,
        "taskId": task_id,
    }
    started = time.time()
    while time.time() - started < CAPTCHA_TIMEOUT:
        r = requests.post(API + "getTaskResult", json=data)
        r_json = r.json()
        check_error(r_json)
        if r_json["status"] == "ready":
            return r_json["solution"]["gRecaptchaResponse"]
        time.sleep(1)
    raise TimeoutError("Captcha solving timeout")