using System.Collections.Generic;
using System.Globalization;
using Newtonsoft.Json;
using UnityEngine;
using WebSocketSharp;
public class HeatWebSocket : MonoBehaviour {
    WebSocket _webSocket;
    private GameManager _gameManager;

    private const string URL = "wss://heat-api.j38.net/channel/462818643";

    private void Start() {
        _gameManager = GameObject.FindWithTag("GameManager").GetComponent<GameManager>();
        
        _webSocket = new WebSocket(URL);
        _webSocket.Connect();
        _webSocket.OnMessage += (sender, messageEventArgs) => {
            var messageEventDataDictionnary = JsonConvert.DeserializeObject<Dictionary<string, string>>(messageEventArgs.Data);

            if (messageEventDataDictionnary != null && messageEventDataDictionnary.ContainsKey("x") && messageEventDataDictionnary.ContainsKey("y")) {
                float x = float.Parse(messageEventDataDictionnary["x"], CultureInfo.InvariantCulture.NumberFormat);
                float y = float.Parse(messageEventDataDictionnary["y"], CultureInfo.InvariantCulture.NumberFormat);

                _gameManager.MoveBaballe(x, y);
            }
        };
        _webSocket.OnError += (sender, messageEventArgs) => { Debug.Log(messageEventArgs.Exception); };
    }
}