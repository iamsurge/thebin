<?php
try {
    $db = checkAndCreateDB('users.db');
    checkAndCreateTable($db, 'users');
} catch (PDOException $e) {
    die('Could not connect to the database:<br/>' . $e);
}
function checkAndCreateDB($db_file) {
    try {
        $db = new PDO('sqlite:' . $db_file);
        $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    } catch (PDOException $e) {
        if (strpos($e->getMessage(), 'no such table') !== false) {
            try {
                $db = new PDO('sqlite:' . $db_file);
                $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
                $db->exec("CREATE TABLE users (
                    id INTEGER PRIMARY KEY,
                    username TEXT NOT NULL,
                    password TEXT NOT NULL
                )");
            } catch (PDOException $e) {
                die('Error creating database: ' . $e->getMessage());
            }
        } else {
            die('Error connecting to database: ' . $e->getMessage());
        }
    }
    return $db;
}
function checkAndCreateTable($db, $table_name) {
    try {
        $query = "SELECT * FROM $table_name";
        $stmt = $db->prepare($query);
        $stmt->execute();
    } catch (PDOException $e) {
        if (strpos($e->getMessage(), 'no such table') !== false) {
            try {
                $db->exec("CREATE TABLE $table_name (
                    id INTEGER PRIMARY KEY,
                    username TEXT NOT NULL,
                    password TEXT NOT NULL
                )");
            } catch (PDOException $e) {
                die('Error creating table: ' . $e->getMessage());
            }
        } else {
            die('Error querying table: ' . $e->getMessage());
        }
    }
}
if (isset($_POST['register'])) {
    $username = $_POST['username'];
    $password = $_POST['password'];
    $confirm_password = $_POST['confirm_password'];
    if ($password != $confirm_password) {
        $error_message = 'Passwords do not match!';
    } else {
        $password_hash = password_hash($password, PASSWORD_DEFAULT);
        try {
            $db->beginTransaction();
            $query = "INSERT INTO users (username, password) VALUES (:username, :password)";
            $stmt = $db->prepare($query);
            $stmt->bindValue(':username', $username);
            $stmt->bindValue(':password', $password_hash);
            $stmt->execute();
            $db->commit();
        } catch (PDOException $e) {
            $db->rollBack();
            $error_message = 'Error registering user: ' . $e->getMessage();
        }
    }
}

if (isset($_POST['login'])) {
    $username = $_POST['username'];
    $password = $_POST['password'];
    try {
        $query = "SELECT password FROM users WHERE username = :username";
        $stmt = $db->prepare($query);
        $stmt->bindValue(':username', $username);
        $stmt->execute();
        $result = $stmt->fetch();
        if (empty($result)) {
            $error_message = 'Invalid username or password';
        } elseif (password_verify($password, $result['password'])) {
            session_start();
            $_SESSION['logged_in'] = true;
            $_SESSION['username'] = $username;
            header('Location: index.php');
            exit;
        } else {
            $error_message = 'Invalid username or password';
        }
    } catch (PDOException $e) {
        $error_message = 'Error logging in: ' . $e->getMessage();
    }
}

if (isset($_POST['logout'])) {
    session_start();
    unset($_SESSION['logged_in']);
    unset($_SESSION['username']);
    session_destroy();
    header('Location: index.php');
    exit;
}
?>


<!DOCTYPE html>
<html>
<head>
    <title>Login and Registration</title>
    <style>
        .error {
            color: red;
        }
    </style>
</head>
<body>
<?php
if (isset($error_message)) {
    echo '<p class="error">' . $error_message . '</p>';
}

if (isset($_SESSION['logged_in']) && $_SESSION['logged_in']): ?>
<p>Welcome, <?php echo $_SESSION['username']; ?></p>
<form method="post" action="">
    <input type="submit" name="logout" value="Logout">
</form>
<?php else: ?>
    <h1>Login</h1>
<form method="post" action="">
    <label for="username">Username:</label><br>
    <input type="text" id="username" name="username"><br>
    <label for="password">Password:</label><br>
    <input type="password" id="password" name="password"><br><br>
    <input type="submit" name="login" value="Login">
</form>

<h1>Registration</h1>
<form method="post" action="">
    <label for="username">Username:</label><br>
    <input type="text" id="username" name="username"><br>
    <label for="password">Password:</label><br>
    <input type="password" id="password" name="password"><br>
    <label for="confirm_password">Confirm Password:</label><br>
    <input type="password" id="confirm_password" name="confirm_password"><br><br>
    <input type="submit" name="register" value="Register">
</form>
<?php endif; ?>
</body>
</html>