// ==UserScript==
// @name         ad block facebook
// @version      4.0
// @description  UPDATED 15/11/2022 Switched everything over to react based detection (the software facebook uses) Should be much more powerful and virtually impossible for FB to get around unless they fundementally change the engine they use (doubtful)
// @updateURL    https://pastebin.com/raw/azwkJETT
// @downloadURL	 https://pastebin.com/raw/azwkJETT
// @include      https://*.facebook.*
// @icon         https://www.google.com/s2/favicons?domain=facebook.com
// @icon64URL    https://www.google.com/s2/favicons?domain=facebook.com
// @run-at       document-idle
// ==/UserScript==

(function () {
    let elementRouting = {}
	
	const sleep = ms => new Promise(resolve => setTimeout(resolve, ms))

    function getFeed() {
        if(!elementRouting?.feed) elementRouting.feed = findFeed()
        return elementRouting.feed
    }

    function findFeed() {
        let divs = document.querySelectorAll('div')
        for(const div of divs)
            if(Object.values(div)?.[1]?.children?.props?.id === 'feed')
                return div
    }

    function feedletsFilter(element) {
        let isFeed = Object.values(element)?.[1]?.children?.props?.variables?.feedLocation !== undefined
        return isFeed
    }

    function getFeedItems() {
        let feedRoot = getFeed()
        let feedItems = Array.from(feedRoot.querySelectorAll('div')).filter(feedletsFilter)
        return feedItems
    }

    function isAdvert(element) {
        let props = Object.values(element)?.[1]?.children?.props
        let feedID = atob(props.story.id)
        if(feedID.length > 500) return true
        return false
    }

    function getAdverts() {
        return getFeedItems().filter(isAdvert)
    }

    function killAdverts() {
        for(const advert of getAdverts())
            advert.parentNode.removeChild(advert)
    }

    async function advertKillingLoop() {
		while(true) {
			try {
				killAdverts()
			} catch {}
			await sleep(250)
		}
    }

    window.addEventListener('load', advertKillingLoop)
})();