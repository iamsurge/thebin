os.loadAPI("json")
local ws, err = http.websocket("ws://10.101.4.244:8081")
local name = "turtle"
 
function start()
  if ws then
    print("Awaiting Commands")
    while true do
      local msg = ws.receive()
      local obj = json.decode(msg)
    
      -- Check for frequency
      local protocol = obj["freq"]
      if protocol == "turtle" then
        local func = loadstring(obj["data"])
        local res0, res1 = func()
        sendMessage("res", res0, res1)
      elseif protocol == "rename" then
        name = obj["data"]
        shell.run("label set " .. name)
      end
    end
  else
    print("Failed to connect")
  end
end
 
 
function sendMessage(freq, data0, data1)
  local out = ""
  local data1str = "false"
  local block = (data1 ~= "No block to inspect") and data1
  if block then data1str = data1.name end
  
  out = out.."{\"freq\":\""..freq.."\","
  out = out.."\"data0\":\""..tostring(data0).."\","
  out = out.."\"data1\":\""..data1str.."\"}"
  
  ws.send(out)
end
 
start()
