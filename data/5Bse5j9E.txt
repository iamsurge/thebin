//Script per analizzare i bias

// Â© Quant Trader Academy
//@version=5
indicator("QTA - Active trading hours", overlay=false)

offset = input.int(1, "Distanza barre", 0, 9999, 1)
coloreBarre = input.color(color.rgb(159, 47, 140), "Colore barre") 
coloreEtichetteSfondo = input.color(color.rgb(19, 50, 70), "Colore sfondo etichetta")
coloreEtichetteTesto = input.color(color.rgb(255, 255, 255), "Colore testo etichetta")
coloreMediaVolume = input.color(color.rgb(89, 159, 220), "Colore Linea Media Volume")
spessoreMediaVolume = input.int(2, "Spessore Linea Media Volume", 1, 9999, 1)

var tabellaInfo = table.new(position = position.top_right, columns = 1, rows = 2, bgcolor = coloreBarre)
var volMedioTrading = 0.0

var h0 = array.new_float(0)
var h1 = array.new_float(0)
var h2 = array.new_float(0)
var h3 = array.new_float(0)
var h4 = array.new_float(0)
var h5 = array.new_float(0)
var h6 = array.new_float(0)
var h7 = array.new_float(0)
var h8 = array.new_float(0)
var h9 = array.new_float(0)
var h10 = array.new_float(0)
var h11 = array.new_float(0)
var h12 = array.new_float(0)
var h13 = array.new_float(0)
var h14 = array.new_float(0)
var h15 = array.new_float(0)
var h16 = array.new_float(0)
var h17 = array.new_float(0)
var h18 = array.new_float(0)
var h19 = array.new_float(0)
var h20 = array.new_float(0)
var h21 = array.new_float(0)
var h22 = array.new_float(0)
var h23 = array.new_float(0)
var averageVolPerHour = array.new_float(0)

array.push(h0, hour(time) == 0 ? volume : na)
array.push(h1, hour(time) == 1 ? volume : na)
array.push(h2, hour(time) == 2 ? volume : na)
array.push(h3, hour(time) == 3 ? volume : na)
array.push(h4, hour(time) == 4 ? volume : na)
array.push(h5, hour(time) == 5 ? volume : na)
array.push(h6, hour(time) == 6 ? volume : na)
array.push(h7, hour(time) == 7 ? volume : na)
array.push(h8, hour(time) == 8 ? volume : na)
array.push(h9, hour(time) == 9 ? volume : na)
array.push(h10, hour(time) == 10 ? volume : na)
array.push(h11, hour(time) == 11 ? volume : na)
array.push(h12, hour(time) == 12 ? volume : na)
array.push(h13, hour(time) == 13 ? volume : na)
array.push(h14, hour(time) == 14 ? volume : na)
array.push(h15, hour(time) == 15 ? volume : na)
array.push(h16, hour(time) == 16 ? volume : na)
array.push(h17, hour(time) == 17 ? volume : na)
array.push(h18, hour(time) == 18 ? volume : na)
array.push(h19, hour(time) == 19 ? volume : na)
array.push(h20, hour(time) == 20 ? volume : na)
array.push(h21, hour(time) == 21 ? volume : na)
array.push(h22, hour(time) == 22 ? volume : na)
array.push(h23, hour(time) == 23 ? volume : na)

disegnaBarra(offset, volMedio, etichetta, colore) =>
    line.new(last_bar_index-offset, 0, last_bar_index - offset, volMedio, color=colore, width=20)
    label.new(x=last_bar_index-offset, y=0, color=coloreEtichetteSfondo, textcolor=coloreEtichetteTesto, style=label.style_label_up, size=size.small, text=etichetta)

if barstate.islast
    array.clear(averageVolPerHour)
    array.push(averageVolPerHour, array.avg(h0))
    array.push(averageVolPerHour, array.avg(h1))
    array.push(averageVolPerHour, array.avg(h2))
    array.push(averageVolPerHour, array.avg(h3))
    array.push(averageVolPerHour, array.avg(h4))
    array.push(averageVolPerHour, array.avg(h5))
    array.push(averageVolPerHour, array.avg(h6))
    array.push(averageVolPerHour, array.avg(h7))
    array.push(averageVolPerHour, array.avg(h8))
    array.push(averageVolPerHour, array.avg(h9))
    array.push(averageVolPerHour, array.avg(h10))
    array.push(averageVolPerHour, array.avg(h11))
    array.push(averageVolPerHour, array.avg(h12))
    array.push(averageVolPerHour, array.avg(h13))
    array.push(averageVolPerHour, array.avg(h14))
    array.push(averageVolPerHour, array.avg(h15))
    array.push(averageVolPerHour, array.avg(h16))
    array.push(averageVolPerHour, array.avg(h17))
    array.push(averageVolPerHour, array.avg(h18))
    array.push(averageVolPerHour, array.avg(h19))
    array.push(averageVolPerHour, array.avg(h20))
    array.push(averageVolPerHour, array.avg(h21))
    array.push(averageVolPerHour, array.avg(h22))
    array.push(averageVolPerHour, array.avg(h23))

    x = 24
    size = array.size(averageVolPerHour) - 1

    for i = 0 to size
        disegnaBarra(offset * x, array.get(averageVolPerHour, i), str.tostring(i), coloreBarre)
        x := x-1
    
    avgVolume = array.avg(id=averageVolPerHour)
    line.new(last_bar_index - (offset * 24), avgVolume , last_bar_index -offset, avgVolume, color=coloreMediaVolume, width=spessoreMediaVolume)

    //testo in alto a dx 
    table.cell(tabellaInfo, 0, 0, "?? Utilizzare l'orario esteso per una migliore visualizzazione", text_color = coloreEtichetteTesto, text_size = size.small, text_halign= text.align_left)
    table.cell(tabellaInfo, 0, 1, "?? Totale barre analizzate: " + str.tostring(bar_index + 1), text_color = coloreEtichetteTesto, text_size = size.small, text_halign= text.align_left)