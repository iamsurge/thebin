"// Get data source\r\nvar tbBalanceList = bottomForm.AllKeys.Where(n => n.StartsWith(\"balance\")).ToList();\r\nvar TCMSIE = db.TCMS_IEPKList.Where(d => d.Trno == PUFNo && d.Kind == PUFKind).ToList();\r\nvar chkLog = db.TCMS_IEPKList_Log.Where(d => d.Trno == PUFNo && d.Kind == PUFKind).ToList();\r\n\r\nforeach (string idx in tbBalanceList)\r\n{\r\n\t// Check if textbox is wrong format\r\n\tif (!TbBalanceDecompose(idx, out string itnbr, out string size, out decimal partPrepareQty))\r\n\t{\r\n\t\ttransc.Rollback();\r\n\t\treturn new TransactionResponse { is_invalid = true, is_success = false, message = \"Error: Wrong format for textbox element name \" + idx + \"!\" };\r\n\t}\r\n\r\n\t// Check if BalanceQty has value\r\n\tvar strItnbrSizeQty = bottomForm[idx];\r\n\tdecimal partPrepareBalance;\r\n\r\n\tif (strItnbrSizeQty == \"\")\r\n\t\tpartPrepareBalance = 0;\r\n\telse\r\n\t\tpartPrepareBalance = Convert.ToDecimal(strItnbrSizeQty);\r\n\r\n\tif (partPrepareBalance != 0)\r\n\t\tisHadPreparationBalance = \"Y\";\r\n\r\n\tpartPrepareQty += partPrepareBalance;\r\n\r\n\t// Check if table TPartPrepareQtys has prepared data\r\n\tvar TPPQ = db.TPartPrepareQtys.Where(d => d.kind == PUFKind && d.trno == PUFNo && d.itnbr == itnbr && d.size == size).FirstOrDefault();\r\n\tif (TPPQ == null)\r\n\t{\r\n\t\tTPPQ = new TPartPrepareQtys()\r\n\t\t{\r\n\t\t\tkind = PUFKind,\r\n\t\t\ttrno = PUFNo,\r\n\t\t\titnbr = itnbr,\r\n\t\t\tsize = size,\r\n\t\t\tPartPrepareBalance = partPrepareBalance,\r\n\t\t\tPartPrepareQty = partPrepareQty,\r\n\t\t\tInsertAt = DTNow\r\n\t\t};\r\n\r\n\t\tdb.TPartPrepareQtys.Add(TPPQ);\r\n\t\tdb.SaveChanges();\r\n\t}\r\n\telse\r\n\t{\r\n\t\ttransc.Rollback();\r\n\t\treturn new TransactionResponse { is_invalid = true, is_success = false, message = \"Error: \" + PUFBarcode + \" already prepared!\" };\r\n\r\n\t}\r\n\r\n\t// Save confirm to MPS_Material_Detail\r\n\r\n\t// Case partPrepareQty > 0 \r\n\tif (partPrepareQty > 0)\r\n\t{\r\n\t\tdecimal remainingQty = partPrepareQty;\r\n\r\n\t\tvar eachTCMSIE = TCMSIE.Where(d => d.Size == size && d.Item_NBR == itnbr).OrderBy(d => d.Cycle_No.Split('#')[1]);\r\n\t\tvar eachTCMSIEperseq = TCMSIE.Where(d => d.Size == size && d.Item_NBR == itnbr).GroupBy(i => i.Cycle_No)\r\n\t\t\t\t\t\t\t\t.Select(g => new TCMS_IEPKList \r\n\t\t\t\t\t\t\t\t{ \r\n\t\t\t\t\t\t\t\t\tMO_No = g.Select(x => x.MO_No).First(),\r\n\t\t\t\t\t\t\t\t\tMO_Seq = g.Select(x => x.MO_Seq).First(),\r\n\t\t\t\t\t\t\t\t\tCycle_No = g.Key,\r\n\t\t\t\t\t\t\t\t\tItem_NBR = g.Select(x => x.Item_NBR).First(),\r\n\t\t\t\t\t\t\t\t\tSize = g.Select(x => x.Size).First(),\r\n\t\t\t\t\t\t\t\t\tP_Qty = g.Sum(x => x.P_Qty),\r\n\t\t\t\t\t\t\t\t}).OrderBy(d => d.Cycle_No.Split('#')[1]).ToList();\r\n\r\n\t\tforeach (var tcmsItem in eachTCMSIEperseq)\r\n\t\t{\r\n\t\t\tif (remainingQty <= 0)\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdecimal planQty = tcmsItem.P_Qty.Value;\r\n\t\t\tdecimal outputQty = remainingQty > planQty ? planQty : remainingQty;\r\n\r\n\t\t\tvar matDetailModel = new MPS_Material_Detail\r\n\t\t\t{\r\n\t\t\t\tMO_No = tcmsItem.MO_No,\r\n\t\t\t\tMO_Batch = tcmsItem.MO_Seq,\r\n\t\t\t\tMO_Sequence = tcmsItem.Cycle_No.Split('#')[1],\r\n\t\t\t\tMaterial_ID = tcmsItem.Item_NBR,\r\n\t\t\t\tMO_Size = tcmsItem.Size,\r\n\t\t\t\tTrno = PUFNo,\r\n\t\t\t\tKind = PUFKind,\r\n\t\t\t\tCycle_No = tcmsItem.Cycle_No,\r\n\t\t\t\tTransaction_Qty = outputQty,\r\n\t\t\t\tInsertAt = DTNow\r\n\t\t\t};\r\n\r\n\t\t\tdb.MPS_Material_Detail.Add(matDetailModel);\r\n\t\t\tdb.SaveChanges();\r\n\r\n\t\t\tremainingQty -= outputQty;\r\n\t\t}\r\n\r\n\t\t// Create MO_Sequence 99 item\r\n\t\tif (remainingQty > 0)\r\n\t\t{\r\n\t\t\tvar TCMSIESrc = TCMSIE\r\n\t\t\t\t.Where(d => d.Size == size && d.Item_NBR == itnbr)\r\n\t\t\t\t.Select(d => new { d.MO_No, d.MO_Seq, d.Item_NBR, d.Size })\r\n\t\t\t\t.FirstOrDefault();\r\n\r\n\t\t\tvar curSeq99Item = db.MPS_Material_Detail\r\n\t\t\t\t.Where(d =>\r\n\t\t\t\t\td.MO_No == TCMSIESrc.MO_No && d.MO_Batch == TCMSIESrc.MO_Seq && d.MO_Sequence == \"99\" &&\r\n\t\t\t\t\td.Material_ID == TCMSIESrc.Item_NBR && d.MO_Size == TCMSIESrc.Size)\r\n\t\t\t\t.FirstOrDefault();\r\n\r\n\t\t\t// Case MO_Sequence 99 doesn't have in table\r\n\t\t\tif (curSeq99Item == null)\r\n\t\t\t{\r\n\t\t\t\tvar matDetailModel = new MPS_Material_Detail\r\n\t\t\t\t{\r\n\t\t\t\t\tMO_No = TCMSIESrc.MO_No,\r\n\t\t\t\t\tMO_Batch = TCMSIESrc.MO_Seq,\r\n\t\t\t\t\tMO_Sequence = \"99\",\r\n\t\t\t\t\tMaterial_ID = TCMSIESrc.Item_NBR,\r\n\t\t\t\t\tMO_Size = TCMSIESrc.Size,\r\n\t\t\t\t\tTrno = PUFNo,\r\n\t\t\t\t\tKind = PUFKind,\r\n\t\t\t\t\tTransaction_Qty = remainingQty,\r\n\t\t\t\t\tInsertAt = DTNow\r\n\t\t\t\t};\r\n\r\n\t\t\t\tdb.MPS_Material_Detail.Add(matDetailModel);\r\n\t\t\t\tdb.SaveChanges();\r\n\r\n\t\t\t\tremainingQty = 0;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tcurSeq99Item.Transaction_Qty += remainingQty;\r\n\t\t\t\tcurSeq99Item.UpdateAt = DTNow;\r\n\r\n\t\t\t\tdb.Entry(curSeq99Item).State = EntityState.Modified;\r\n\t\t\t\tdb.SaveChanges();\r\n\r\n\t\t\t\tremainingQty = 0;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nvar TPPD = new TPartPrepareDates()\r\n{\r\n\tkind = PUFKind,\r\n\ttrno = PUFNo,\r\n\tPartPrepareDate = DTNow,\r\n\tInsertAt = DTNow,\r\n\tisHadPrepareBalance = isHadPreparationBalance,\r\n};\r\n\r\ndb.TPartPrepareDates.Add(TPPD);\r\ndb.SaveChanges();\r\n\r\nTPFS.prepare_at = DTNow;\r\nTPFS.prepare_by = user;\r\nTPFS.prepare_actualAt = DTNow;\r\n//2021-10-5 新增欄位更新 Add By Alan\r\nTPFS.Close_Flag = \"N\";\r\nTPFS.Biz_Flag = \"N\";\r\nTPFS.Biz_Finish = null;\r\nTPFS.Update_By = user;\r\n                    TPFS.Update_Time = DTNow;"