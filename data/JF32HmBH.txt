// Build by Ashutosh Yadav



try {
  if (processData.descFlag != "1" && processData.descFlag != undefined) {
    if (processData.freight_carrier_code == "MAIN") {
      if (processData.status_leg_mf == "1DEPSEA" && processData.actual_time_mf) {
        processData.confirmed_on_board = processData.actual_time_mf;
      }
      if (processData.status_leg_mf == "99DCFROA" && processData.estimated_time_mf) {
        processData.out_for_delivery = processData.estimated_time_mf;
        processData.current_shipment_stage = "Out for Delivery";
      }
      if (processData.status_leg_mf == "99DCFROA" && processData.actual_time_mf) {
        processData.delivery_report = processData.actual_time_mf;
      }

      processData.leg_mf = processData.leg_number_mf.toString();
      var arr = processData.obj_stf_array_mf;
      var isPresent = "FALSE";

      for (var i = 0; i < arr.length; i++) {
        if (
          arr[i].obj_leg_mf == processData.leg_number_mf.toString() &&
          arr[i].obj_milestone_mf == processData.milestone_mf &&
          arr[i].obj_mode_mf == processData.mode_mf
        ) {
          isPresent = "TRUE";
          arr[i].obj_eta_mf == processData.estimated_time_mf;
          arr[i].obj_ata_mf == processData.actual_time_mf;
        }
      }

      if (isPresent == "FALSE") {
        var obj = {
          obj_leg_mf: processData.leg_number_mf.toString(),
          obj_milestone_mf: processData.milestone_mf,
          obj_mode_mf: processData.mode_mf,
          obj_eta_mf: processData.estimated_time_mf,
          obj_ata_mf: processData.actual_time_mf,
        };
        arr.push(obj);
        if (processData.actual_time_mf) {
          if (processData.status_leg_mf == "0PCFROA") {
            processData.current_status = "Road - Picked up from Origin";
          }
          if (processData.status_leg_mf == "1DEPRAI") {
            processData.current_status = "Rail - Departed for Origin";
          }
          if (processData.status_leg_mf == "1ARVRAI") {
            processData.current_status = "Rail - Arrived at Origin";
          }
          if (processData.status_leg_mf == "1DEPSEA") {
            processData.current_status = "Sea - Departed for Origin Port";
          }
          if (processData.status_leg_mf == "1ARVSEA") {
            processData.current_status = "Sea - Arrived at Origin Port";
          }
          if (processData.status_leg_mf == "1DEPROA") {
            processData.current_status = "Road - Departed for Origin";
          }
          if (processData.status_leg_mf == "1ARVROA") {
            processData.current_status = "Road - Arrived at Origin";
          }
          if (processData.status_leg_mf == "1DEPAIR") {
            processData.current_status = "Air - Departed for Origin";
          }
          if (processData.status_leg_mf == "1ARVAIR") {
            processData.current_status = "Air - Arrived at Origin";
          }

          if (processData.status_leg_mf == "2DEPSEA") {
            processData.current_status = "Sea - Departed from Destination Port";
          }
          if (processData.status_leg_mf == "2ARVSEA") {
            processData.current_status = "Sea - Arrived at Destination Port";
          }
          if (processData.status_leg_mf == "2DEPRAI") {
            processData.current_status = "Rail - Departed towards Destination";
          }
          if (processData.status_leg_mf == "2ARVRAI") {
            processData.current_status = "Rail - Arrived at Destination";
          }
          if (processData.status_leg_mf == "2DEPROA") {
            processData.current_status = "Road - Departed towards Destination";
          }
          if (processData.status_leg_mf == "2ARVROA") {
            processData.current_status = "Road - Arrived at Destination";
          }
          if (processData.status_leg_mf == "2DEPAIR") {
            processData.current_status = "Air - Departed towards Destination";
          }
          if (processData.status_leg_mf == "2ARVAIR") {
            processData.current_status = "Air - Arrived at Destination";
          }

          if (processData.status_leg_mf == "3DEPSEA") {
            processData.current_status = "Sea - Departed from Destination Port";
          }
          if (processData.status_leg_mf == "3ARVSEA") {
            processData.current_status = "Sea - Arrived at Destination Port";
          }
          if (processData.status_leg_mf == "3DEPRAI") {
            processData.current_status = "Rail - Departed towards Destination";
          }
          if (processData.status_leg_mf == "3ARVRAI") {
            processData.current_status = "Rail - Arrived at Destination";
          }
          if (processData.status_leg_mf == "3DEPROA") {
            processData.current_status = "Road - Departed towards Destination";
          }
          if (processData.status_leg_mf == "3ARVROA") {
            processData.current_status = "Road - Arrived at Destination";
          }
          if (processData.status_leg_mf == "3DEPAIR") {
            processData.current_status = "Air - Departed towards Destination";
          }
          if (processData.status_leg_mf == "3ARVAIR") {
            processData.current_status = "Air - Arrived at Destination";
          }

          if (processData.status_leg_mf == "4DEPSEA") {
            processData.current_status = "Sea - Departed from Destination Port";
          }
          if (processData.status_leg_mf == "4ARVSEA") {
            processData.current_status = "Sea - Arrived at Destination Port";
          }
          if (processData.status_leg_mf == "4DEPRAI") {
            processData.current_status = "Rail - Departed towards Destination";
          }
          if (processData.status_leg_mf == "4ARVRAI") {
            processData.current_status = "Rail - Arrived at Destination";
          }
          if (processData.status_leg_mf == "4DEPROA") {
            processData.current_status = "Road - Departed towards Destination";
          }
          if (processData.status_leg_mf == "4ARVROA") {
            processData.current_status = "Road - Arrived at Destination";
          }
          if (processData.status_leg_mf == "4DEPAIR") {
            processData.current_status = "Air - Departed towards Destination";
          }
          if (processData.status_leg_mf == "4ARVAIR") {
            processData.current_status = "Air - Arrived at Destination";
          }

          if (processData.status_leg_mf == "99DCFROA") {
            processData.current_status = "Road - Delivered at Destination";
          }
          processData.remarks = "ATA: " + processData.actual_time_mf;
        }
      }
      processData.obj_stf_array_mf = arr;

      var delArr = [];
      for (var i = 0; i < processData.deliveryArray_mf.length; i++) {
        delArr.push(processData.deliveryArray_mf[i]);
      }

      for (var i = 0; i < processData.containerArray_mf.length; i++) {

        //update generic process
        var message = {
          referenceNumber: processData.containerArray_mf[i] + "_" + processData.mbol_mf,
          processMasterCode: "update_to_trn",
          flowCode: "hold_to_update",
          moveFlowForward: true,
          processData: {
            //optional
            container_id: processData.containerArray_mf[i],
            bl_number: processData.mbol_mf,
            job_number: processData.job_number_mf,
            del_array: delArr,
            leg: processData.leg_number_mf.toString(),
            ff_code: processData.freight_carrier_code
          },
        };
        throwIntermediateMessageEvent(
          "Intermediate Message Event",
          JSON.stringify(message)
        );
      }

    }


    if (processData.freight_carrier_code == "EXPD") {
      if (processData.road_out_for_delivery_expd != undefined && processData.road_out_for_delivery_expd) {
        processData.out_for_delivery = processData.road_out_for_delivery_expd;
        processData.current_shipment_stage = "Out for Delivery";
      }
      if (processData.roadDelivered_expd != undefined && processData.roadDelivered_expd) {
        processData.delivery_report = processData.roadDelivered_expd;
      }
      processData.confirmed_on_board = processData.oceanConfirmedOnBoard_expd;
      //TEMP HBOL ARRAY
      var arr1 = [];
      for (var i = 0; i < processData.hbol_array_expd.length; i++) {
        arr1.push(processData.hbol_array_expd[i]);
      }
      if (processData.roadFreightReceived_expd) {
        processData.current_status = "Road - Freight Received";
        processData.remarks = processData.roadFreightReceived_expd;
      }
      if (processData.oceanBookedEtd_expd) {
        processData.current_status = "Ocean - Booked ETD";
        processData.remarks = processData.oceanBookedEtd_expd;
      }
      if (processData.oceanConfirmedOnBoard_expd) {
        processData.current_status = "Ocean - Confirmed on Board";
        processData.remarks = processData.oceanConfirmedOnBoard_expd;
      }
      if (processData.oceanEtaPortUnloading_expd) {
        processData.current_status = "Ocean - ETA Port Unloading";
        processData.remarks = processData.oceanEtaPortUnloading_expd;
      }
      if (processData.oceanAtaPortUnloading_expd) {
        processData.current_status = "Ocean - ATA Port Unloading";
        processData.remarks = processData.oceanAtaPortUnloading_expd;
      }
      if (processData.loadedOnRail_expd) {
        processData.current_status = "Rail - Loaded On Rail";
        processData.remarks = processData.loadedOnRail_expd;
      }
      if (processData.oceanETADestination_expd) {
        processData.current_status = "Rail/Road - ETA Destination";
        processData.remarks = processData.oceanETADestination_expd;
      }
      if (processData.railArrivedOnRail_expd) {
        processData.current_status = "Rail - Arrived on rail";
        processData.remarks = processData.railArrivedOnRail_expd;
      }
      if (processData.oceanATAFinalDestination_expd) {
        processData.current_status = "Rail/Road - ATA Destination";
        processData.remarks = processData.oceanATAFinalDestination_expd;
      }
      if (processData.road_out_for_delivery_expd) {
        processData.road_out_for_delivery_expd = "Road - Out for Delivery";
        processData.remarks = processData.road_out_for_delivery_expd;
      }
      if (processData.roadETADelivery_expd) {
        processData.current_status = "Road - ETA Delivery";
        processData.remarks = processData.roadETADelivery_expd;
      }
      if (processData.roadDelivered_expd) {
        processData.current_status = "Road - Delivered";
        processData.remarks = processData.roadDelivered_expd;
      }
      var arr2 = [];
      for (var i = 0; i < processData.poArray_expd.length; i++) {
        arr2.push(processData.poArray_expd[i]);
      }

      if (processData.mbol_expd_array.length == 1) {
        processData.mbol_expd = processData.mbol_expd_array[0];
        var message = {
          "referenceNumber": processData.container_no_expd + "_" + processData.mbol_expd,
          "processMasterCode": "update_to_trn",
          "flowCode": "hold_to_update",
          "moveFlowForward": true,
          "processData": { //optional
            "container_id": processData.container_no_expd,
            "bl_number": processData.mbol_expd,
            "del_array": arr2,
            "house_bol": arr1[0],
            "ff_code": processData.freight_carrier_code,
            "roadDelivered": processData.roadDelivered_expd,
            "leg": "1"
          }
        };
        throwIntermediateMessageEvent("Intermediate Message Event", JSON.stringify(message));
      }
    }









    //FLAG DECISION
    if (processData.freight_carrier_code == "MAIN") {
      if (processData.leg_number_mf == 99 && processData.actual_time_mf) {
        processData.flag = "99";
      }
    }
    if (processData.freight_carrier_code == "EXPD") {
      if (processData.roadDelivered_expd) {
        processData.flag = "99";
      }
    }
  } else {
    // ETA Door calculation pending
    var eta = processData.fareye_eta;

    // Fetching distance and calucating eta using Data Store    CHANGES TO BE DONE

    if (processData.freight_carrier_code == "MAIN") {
      var isDataStorePresent = "0";
      fetchRecordsFromDataStore();
      for (var i = 0; i < dataStoreData.length; i++) {
        var ultimateDropLoc = processData.ultimate_drop_location;
        var dischargePort = processData.discharge_port_mf;
        var requestCombination = "";
        requestCombination = dischargePort + "-" + ultimateDropLoc;
        if (dataStoreData[i].key == requestCombination) {
          isDataStorePresent = "1";
          var obj = dataStoreData[i].data;
          var distance = obj.distance;
          var calculatedDist = Math.floor(((distance / 55) / 12));

          function addDays(eta, calculatedDist) {
            var result = new Date(eta);
            result.setDate(result.getDate() + calculatedDist);
            return result;
          }

          var result = addDays(eta, calculatedDist);

          // Ontime days calculation
          var expRecpDate = processData.expected_receipt_date;
          var expRecptDateObject = new Date(expRecpDate);
          var differenceInTime = result.getTime() - expRecptDateObject.getTime();
          var differenceInDays = Math.floor(differenceInTime / (1000 * 60 * 60 * 24));
          var answer = "";
          answer = processData.expected_receipt_date + " / " + differenceInDays;
          processData.on_time_days_count = answer;

          var modAnswer = (answer < 0 ? -(answer) : answer);

          if (modAnswer >= 0 && modAnswer <= 5) {
            processData.delay_early_status = "GREEN";
          } else if (modAnswer >= 6 && modAnswer <= 14) {
            processData.delay_early_status = "YELLOW";
          } else if (modAnswer >= 15) {
            processData.delay_early_status = "RED";
          }


          processData.fareye_eta_2_door = result;
        }
        if (isDataStorePresent == "0") {
          exception.throwException('ERROR ! The Entered Value: ' + requestCombination + ' Does Not Exist In Datastore');
        }
      }
    }

    if (processData.freight_carrier_code == "EXPD") {
      var isDataStorePresent = "0";
      fetchRecordsFromDataStore();
      for (var i = 0; i < dataStoreData.length; i++) {
        var ultimateDropLoc = processData.ultimate_drop_location;
        var dischargePort = processData.port_of_unloading_expd;
        var requestCombination = "";
        requestCombination = dischargePort + "-" + ultimateDropLoc;
        if (dataStoreData[i].key == requestCombination) {
          isDataStorePresent = "1";
          var obj = dataStoreData[i].data;
          var distance = obj.distance;
          var calculatedDist = Math.floor(((distance / 55) / 12));

          function addDays(eta, calculatedDist) {
            var result = new Date(eta);
            result.setDate(result.getDate() + calculatedDist);
            return result;
          }

          var result = addDays(eta, calculatedDist);

          // Ontime days calculation
          var expRecpDate = processData.expected_receipt_date;
          var expRecptDateObject = new Date(expRecpDate);
          var differenceInTime = result.getTime() - expRecptDateObject.getTime();
          var differenceInDays = Math.floor(differenceInTime / (1000 * 60 * 60 * 24));
          var answer = "";
          answer = processData.expected_receipt_date + " / " + differenceInDays;
          processData.on_time_days_count = answer;

          var modAnswer = (answer < 0 ? -(answer) : answer);

          if (modAnswer >= 0 && modAnswer <= 5) {
            processData.delay_early_status = "GREEN";
          } else if (modAnswer >= 6 && modAnswer <= 14) {
            processData.delay_early_status = "YELLOW";
          } else if (modAnswer >= 15) {
            processData.delay_early_status = "RED";
          }

          processData.fareye_eta_2_door = result;
        }
        if (isDataStorePresent == "0") {
          exception.throwException('ERROR ! The Entered Value: ' + requestCombination + ' Does Not Exist In Datastore');
        }
      }
    }

    processData.descFlag = "0";
  }
} catch (e) {

}