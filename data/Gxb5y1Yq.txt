#!/bin/bash

replacedate=$(cat /tmp/adcertexpiration)
datenow=$(/usr/bin/date +"%s")

identity_source_name=
baseUserDN=
baseGroupDN=
domain=
alias=
username=
password=
adserver=
adport=
sslCert="/tmp/adcert.cer"

if [ ${datenow} -gt ${replacedate} ]; then
  echo "" | openssl s_client -connect ${adserver}:${adport} -prexit 2 > /dev/null | /usr/bin/sed -n -e '/BEGIN\ CERTIFICATE/,/END\ CERTIFICATE/ p' > ${sslCert}

  /opt/vmware/bin/sso-config.sh -delete_identity_source -i ${identity_source_name}

  /opt/vmware/bin/sso-config.sh -add_identity_source -type adldap -i ${identity_source_name} -baseUserDN ${baseUserDN} -baseGroupDN ${baseGroupDN} -domain ${domain} -alias ${alias} -username ${username} -password ${password} -primaryURL "ldaps://${adserver}:${adport}" -useSSL true -sslCert ${sslCert}

  /opt/vmware/bin/sso-config.sh -set_default_identity_sources -i ${identity_source_name}
fi