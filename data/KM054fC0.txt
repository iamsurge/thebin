import android.content.Context
import android.util.Log
import androidx.datastore.core.DataStore
import androidx.datastore.preferences.core.Preferences
import androidx.datastore.preferences.core.edit
import androidx.datastore.preferences.preferencesDataStore
import kotlinx.coroutines.flow.Flow


/**
 * Base preferences manager
 */
abstract class PreferencesManager<P> protected constructor(
    protected val context: Context,
) {
    private companion object {
        const val TAG = "PreferencesManager"
    }

    /**
     * Should be implemented by delegating it to [preferencesDataStore]
     */
    protected abstract val Context.dataStore: DataStore<Preferences>

    abstract val preferencesFlow: Flow<P>

    protected abstract fun mapPreferencesToType(preferences: Preferences): P

    protected open suspend fun <VT> setKey(key: Preferences.Key<VT>, value: VT): Preferences {
        Log.d(TAG, "Setting preferences key $key with value $value")
        return context.dataStore.edit { preferences ->
            preferences[key] = value
        }
    }
}