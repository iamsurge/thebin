// Lorenzo version
db.articles.aggregate([
    {
        $unwind: {
          path: "$sections",
          includeArrayIndex: 'sectionIndex',
          preserveNullAndEmptyArrays: true,
        }
    },
    {
        $unwind: {
            path: "$sections.subsections",
            preserveNullAndEmptyArrays: true,
        }
    },
    {
        $group: {
            _id: {
                article: "$_id",
                sectionIndex: "$sectionIndex",
                n_section_figures: {$size: { $ifNull: [ "$sections.figures", [] ] }},
                n_section_paragraphs: {$size: { $ifNull: [ "$sections.paragraphs", [] ] }},
            },
            n_subsections_paragraphs: {
                $sum: {
                    $size: { $ifNull: [ "$sections.subsections.paragraphs", [] ] }
                } 
            },
            n_subsections_figures: {
                $sum: {
                    $size: { $ifNull: [ "$sections.subsections.figures", [] ] }
                } 
	        },
            n_subsections: {
                $sum: {
                    $cond: [
                        { $ifNull: [ "$sections.subsections", false ] },
                        1,
                        0
                    ]
                } 
            }
        }
    },
    {
        $group: {
            _id: "$_id.article",
            rank: {
                $sum: {
                    $add: [
                        {
                            $multiply: [
                                "$n_subsections",
                                10
                            ]
                        },
                        {
                            $multiply: [
                                {$add: ["$_id.n_section_paragraphs", "$n_subsections_paragraphs"]},
                                5
                            ]
                        },
                        {
                            $multiply: [
                                {$add: ["$_id.n_section_figures", "$n_subsections_figures"]},
                                2
                            ]
                        }
                    ]
                }
            }
        }
    },
    {
        $sort: {
            rank: -1
        }
    },
    {
        $limit: 5
    } 
])