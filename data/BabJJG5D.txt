CREATE TRIGGER WRONGDATE ON dbo.Orders
AFTER INSERT
AS BEGIN
	IF EXISTS (SELECT ONUM FROM inserted
				WHERE NOT CAST(ODATE AS DATE) = CAST(GETDATE() AS DATE))
	BEGIN
		PRINT('Ошибка! Дата заказа не ' + CAST(GETDATE() AS VARCHAR) + '!');
		DELETE FROM Orders
		WHERE ONUM IN (SELECT ONUM FROM inserted
						WHERE NOT CAST(ODATE AS DATE) = CAST(GETDATE() AS DATE));
	END
END
GO

CREATE VIEW ITOGI AS
SELECT
	ONUM,
	ODATE,
	(SELECT SUM(PRICE*QUANTITY)
	FROM Order_Details JOIN Product
	ON Order_Details.PNUM = Product.PNUM
	WHERE Order_Details.ONUM = Orders.ONUM)
FROM Orders
WHERE ONUM IN
	(SELECT ONUM
	FROM Order_Details);
GO