<!--
v221124b - Ok fetch SNA file and create downloadable SNA

To DO:
-Show contents (like PHP version)
-->
<div id="txt">Lorem Ipsum</div>
<br />
<button id="test">Download text as file !</button>

<script type="text/javascript">
var client = new XMLHttpRequest();
var sna_contents;
const hexdec = hex => parseInt(hex, 16);//Convert Hex to Dec hexdec("A23F")
const dechex = dec => parseInt(dec, 10);//Convert Hex to Dec hexdec("A23F")



var addr_array = {
  "00004A2B":"A ethniki",
  //"00004B07"=>"B ethniki",
  "00004B07":"B ethniki",
  "00004BE3":"G ethniki",

  "00004CBF":"D ethniki",
  "00004D9B":"Champions league",
  //"00024B07"=>"EEtniki???",
  "00004E77":"ETHINES omades ethniki",
    
};
for (const key in addr_array) {
  const value = addr_array[key];
  console.log(key, value);
  console.log(key," -> ",hexdec(key));
}




client.open('GET', 'fb_year_test.sna',true);
//client.responseType = "arraybuffer";
client.responseType = "blob";
client.onreadystatechange = function() {
  if (client.status === 200 && client.readyState === 4) {
  //alert(client.responseText);
  //console.log(client.responseText);
  console.log(client.response);
  //sna_contents=client.responseText;
  sna_contents=client.response;
  //var byteSize = //sna_contents => new Blob([sna_contents]).size;
  var byteSize = new Blob([client.response]).size;
  //var byteSize = new Blob([sna_contents]).size;
  var byteSize =client.response.size;
  console.log("bytesize===="+byteSize);





  var index_add=0;
  //foreach($addr_array as $pos => $pos_team ){
  for (const pos in addr_array) {  
          //echo "<h3>$pos , $pos_team </h3>";
          position=hexdec(pos);
          //console.log(client.response);
          index_add=0;
          for(var i=1;i<23;i++){
              //fseek($f, $position+$index_add);
              //teamname=fread($f,9);
              //teamname=client.response.substring(position+index_add, 9);// PROMISE...//SUBSTRINGfread($f,9);
              teamname=client.response.slice(position+index_add, 9);
              //fseek($f, $position+$index_add);
              //console.log(  "<li>"+i+" ) "+teamname+" (position+index_add(index_add))".dechex(position+index_add) );
              console.log(  "<li>"+i+" ) "+teamname+" ("+(position+index_add)+" (index_add=))"+index_add);
              //if ($write_enabled)fwrite($f, $data);
              index_add=10*i;
          } //End of for($i=1;$i,30l$i++){
          console.log( "<HR>");
  } //foreach($addr_array as $pos => $pos_team ){

}//end of if (xmlhttp.status === 200) {

}
client.send();

//sna_contents="";






function download_txt() {
  //var textToSave = document.getElementById('txt').innerHTML;
  var textToSave=sna_contents;
  var ia = new Uint8Array(sna_contents);          // Array converted to typed array incl. content
  //var file = new Blob([ia], {type: "application/octet-stream"});
  var file = new File([ia], "hexfile.sna", {type: "application/octet-stream"});
  document.location = URL.createObjectURL(file);
  /*
  var hiddenElement = document.createElement('a');

//  hiddenElement.href = 'data:attachment/text,' + encodeURI(textToSave);
  hiddenElement.href = 'data:attachment/text,' + encodeURI(textToSave);
  console.log(textToSave);
  hiddenElement.target = '_blank';
  hiddenElement.download = 'myFile.sna';
  hiddenElement.click();
  */
}

document.getElementById('test').addEventListener('click', download_txt);

</script>

