services:
  # Keycloak service on Quarkus:
  keycloak:
    build:
      context: .
      dockerfile: ./.docker/containers/keycloack/Dockerfile
      args:
        ## database environment params:
        KEYCLOAK_DATABASE_VENDOR: "${DATABASE_VENDOR}"
        ## hostname and HTTP/TLS related params:
        KEYCLOAK_HOSTNAME: "${KEYCLOAK_HOSTNAME}"
        KEYCLOAK_HOSTNAME_ADMIN: "${KEYCLOAK_HOSTNAME_ADMIN}"
        KEYCLOAK_HOSTNAME_STRICT: "${KEYCLOAK_HOSTNAME_STRICT}"
        KEYCLOAK_PROXY: "${KEYCLOAK_PROXY}"
        KEYCLOAK_HTTP_HOST: "${KEYCLOAK_HOST_NETWORK}"
        KEYCLOAK_HTTP_PORT: "${KEYCLOAK_HTTP_PORT}"
        KEYCLOAK_HTTP_ENABLED: "${KEYCLOAK_HTTP_ENABLED}"
        KEYCLOAK_HOSTNAME_STRICT_HTTPS: "${KEYCLOAK_HOSTNAME_STRICT_HTTPS}"
        ## health, metrics, features, and loggins related params:
        KEYCLOAK_HEALTH_ENABLED: "${KEYCLOAK_HEALTH_ENABLED}"
        KEYCLOAK_METRICS_ENABLED: "${KEYCLOAK_METRICS_ENABLED}"
        KEYCLOAK_FEATURES: "${KEYCLOAK_FEATURES}"
        KEYCLOAK_LOG_LEVEL: "${KEYCLOAK_LOG_LEVEL}"
    container_name: "${KEYCLOAK_CONTAINER_NAME}"
    restart: &restartpolicy unless-stopped
    ports:
      - "${KEYCLOAK_HOST_NETWORK}:${KEYCLOAK_HOST_PORT}:${KEYCLOAK_HTTP_PORT}"
      - "${KEYCLOAK_HOST_NETWORK}:8443:8443"
    env_file: .env
    environment:
      ## Keycloak ACL related params:
      KEYCLOAK_ADMIN: "${KEYCLOAK_ADMIN_USERNAME}"
      KEYCLOAK_ADMIN_PASSWORD: "${KEYCLOAK_ADMIN_PASSWORD}"
      ## Keycloak Database related config:
      KC_DB_URL: "jdbc:${DATABASE_VENDOR_JDBC}://${DATABASE_CONTAINER_NAME}:${DATABASE_PORT}/${DATABASE_NAME}"
      KC_DB_USERNAME: "${DATABASE_USER}"
      KC_DB_PASSWORD: "${DATABASE_PASSWORD}"
      KC_DB_SCHEMA: "${DATABASE_SCHEMA}"
    depends_on:
      - database
    networks:
      - traefik-proxy
      - private
    # only for quarkus image; possible commands: start | start-dev
    # it is the param passed  to kc.sh script
    command:
      # start in production mode:
      - "start --optimized"
    labels:
      # Traefik general config
      - traefik.enable=true
      # docker shared network to avoid communication between containers:
      - traefik.docker.network=${TRAEFIK_SHARED_DOCKER_NETWORK_NAME}
      # entrypoint HTTP (not secure) from web (HTTP)
      - traefik.http.routers.keycloak-http.entrypoints=web
      # entrypoint HTTP (not secure) rule:
      - traefik.http.routers.keycloak-http.rule=Host(`${KEYCLOAK_HOSTNAME}`,`${KEYCLOAK_HOSTNAME_ADMIN}`)
      # entrypoint HTTP (not secure) middleware, to secure HTTPS:
      - traefik.http.routers.keycloak-http.middlewares=keycloak-https
      # middleware to redirect HTTP to HTTPS
      - traefik.http.middlewares.keycloak-https.redirectscheme.scheme=https
      # entrypoint HTTPS (the desired default):
      - traefik.http.routers.keycloak.entrypoints=websecure
      # rules for https entrypoint:
      - traefik.http.routers.keycloak.rule=Host(`${KEYCLOAK_HOSTNAME}`,`${KEYCLOAK_HOSTNAME_ADMIN}`)
      # TLS:
      - traefik.http.routers.keycloak.tls=true
      - traefik.http.routers.keycloak.tls.certresolver=production
      # services:
      - traefik.http.services.keycloak.loadbalancer.server.port=${KEYCLOAK_HTTP_PORT}