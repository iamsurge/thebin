#!/bin/bash

SALIDA=0
FECHACTUAL=$(date +%d-%m-%Y-%T)
CICLO=1
CONTROLADORCI=0
CONTROLADORFECHAI=0 #CONTROLADOR DE FECHA INICIAL
CONTROLADORFECHAF=0 #CONTROLADOR DE FECHA FINAL
CODIGO=$(cat codigo.txt)
USUARIO=$(cat usuarioensistema.txt | cut -d : -f4)

#CONTROLA QUE LA CI DEL USUARIO SEA LA CORRECTA.

while [ $CONTROLADORCI -eq 0 -a $CICLO -lt 4 ] #CONTROLADORCI == 0 y CICLO < 4 se ejecuta.
do
clear
echo
echo "     ALTA - $USUARIO" #Busco en usuarioensistema.txt y corto solo el usuario.
echo
read -p " Ingrese CI: " CI

        for cidocente in $(cat listadocentes.txt | cut -d : -f1) #Recorre listaDocentes.txt y corta las filas en ":".
        do
                if [[ $cidocente == $CI ]] #Si la cidocente es igual a CI, entonces la ci es correcta.
                then
                        CONTROLADORCI=1 #Si la ci es correcta CONTROLADORCI se le agrega el valor de 1 para terminar el ciclo while.
                	CICLO=1
		fi
        done

        if [[ $CONTROLADORCI -eq 0 ]] #CONTROLADORUSUARIO == 0 el usuario va hacer incorrecto.
        then
                echo
                echo " CI incorrecta - Intento $CICLO/3"
                echo

                CICLO=$((CICLO+1)) #CICLO le sumamos 1 que serian los intentos errados.

                if [[ $CICLO == 4 ]] #CICLO es igual a 4, termina el programa.
                then
                        echo " Este fue su ultimo intento"
                        read -p " Presione 'ENTER' para salir..."
                        exit
                else
                        read -p " Presione 'ENTER' para volver a intentarlo..."
                fi
        fi
done

#CONTROLA QUE LA FECHA DE INICIO SEA CORRECTA.

while [ $CONTROLADORFECHAI -eq 0 ]
do
	clear
	echo
	echo "     ALTA - $USUARIO"
	echo
	echo " Ingrese CI: $CI"
	echo
	echo " Fecha de inicio: "
	read -p " Ingrese el dia: " DIAI #"DIAI" = "DIA DE FECHA DE INICIO"
	read -p " Ingrese el mes: " MESI #"MESI" = "MES DE FECHA DE INICIO"
	read -p " Ingrese el año: " ANIOI #"ANIOI" = "AÑO DE FECHA DE INICIO"

	# > /dev/null 2> &1 ANULA LA SALIDA ESTANDAR Y LA SALIDA DE ERROR REDIRECCIONANDOLAS PARA QUE NO SE OBTENGA NINGUNA INFORMACION POR CONSOLA.
	if date -d "$ANIOI/$MESI/$DIAI" > /dev/null 2>&1 #COMPARA QUE LA FECHA SEA CORRECTA
	then
		FECHAI="$ANIOI/$MESI/$DIAI" #GUARDA LA FECHA INGRESADA POR EL USUARIO EN "FECHAI" = "FECHA DE INICIO"
		CONTROLADORFECHAI=1
		CICLO=1
	else
		echo
		echo " Fecha incorrecta - Intento $CICLO/3"
		echo
		
		CICLO=$((CICLO+1))

		if [[ $CICLO == 4 ]]
		then
			echo " Este fue su ultimo intento"
			read -p " Presione 'ENTER' para salir..."
		else
			read -p " Presione 'ENTER' para volver a intentarlo..."
		fi
	fi
done

#CONTROLA QUE LA FECHA FINAL SEA CORRECTA.

while [ $CONTROLADORFECHAF -eq 0 ]
do
	clear
	echo
	echo "     ALTA - $USUARIO" #Busco en usuarioensistema.txt y corto solo el usuario.
	echo
	echo " Ingrese CI: $CI"
	echo
	echo " Fecha de inicio: $FECHAI"
	echo
	echo " Fecha de fin: "
	read -p " Ingrese el dia: " DIAF #"DIAF" = "DIA DE FECHA DE FIN"
	read -p " Ingrese el mes: " MESF #"MESF" = "MES DE FECHA DE FIN"
	read -p " Ingrese el año: " ANIOF #"ANIOF" = "AÑO DE FECHA DE FIN"

	# > /dev/null 2> &1 ANULA LA SALIDA ESTANDAR Y LA SALIDA DE ERROR REDIRECCIONANDOLAS PARA QUE NO SE OBTENGA NINGUNA INFORMACION POR CONSOLA.
	if date -d "$ANIOF/$MESF/$DIAF" > /dev/null 2>&1 #COMPARA QUE LA FECHA SEA CORRECTA
	then
		FECHAF="$ANIOF/$MESF/$DIAF" #GUARDA LA FECHA INGRESADA POR EL USUARIO EN "FECHAF" = "FECHA DE FIN"
		CONTROLADORFECHAF=1
		CICLO=1
		echo "$CODIGO:$(cat listadocentes.txt | egrep "^$CI:" | cut -f1-3 -d :):$FECHAI:$FECHAF:$FECHACTUAL:$USUARIO" >> listaaltas.txt #Guarda el los datos necesarios en listaaltas.txt
		echo $((CODIGO+1)) > codigo.txt #Cambia el codigo sumandole 1 para que el proximo ingreso no contenga el mismo codigo.
	else
		echo
		echo " Fecha incorrecta - Intento $CICLO/3" 
		echo
		
		CICLO=$((CICLO+1))

		if [[ $CICL0 == 4 ]]
		then
			echo " Este fue su ultimo intento"
			read -p " Presione 'ENTER' para salir..."
		else
			read -p " Presione 'ENTER' para volver a intentarlo..."
		fi
	fi
done

#CONTROLADOR DE SALIDA O NUEVO INGRESO

while [ $SALIDA -eq 0 ]
do
	clear
	echo
	echo "     ALTA - $USUARIO"
	echo
	echo " Ingrese CI: $CI"
	echo
	echo " Fecha de incio: $FECHAI"
	echo
	echo " Fecha de fin: $FECHAF"
	echo
	echo " ¿Desea hacer un nuevo ingreso?"
	echo
	echo " 1 - Nuevo ingreso"
	echo " 2 - Salir"
	read -p " " NUEVALTA
	
	case $NUEVALTA in
		1) bash alta.bash
		SALIDA=1
		;;
		2) bash menu.bash
		SALIDA=1
		;;
		*) echo
		echo " La opcion ingresada no es correcta"
		read -p " Presione 'ENTER' para volver intentarlo..."
	esac
done
